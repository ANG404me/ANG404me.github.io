<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>低功耗蓝牙BLE | ANG404's Blog</title><meta name="author" content="ANG404"><meta name="copyright" content="ANG404"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="低功耗蓝牙协议栈以及工作流程。">
<meta property="og:type" content="article">
<meta property="og:title" content="低功耗蓝牙BLE">
<meta property="og:url" content="https://ang404me.github.io/2023/09/01/%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99/index.html">
<meta property="og:site_name" content="ANG404&#39;s Blog">
<meta property="og:description" content="低功耗蓝牙协议栈以及工作流程。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.unsplash.com/photo-1570993492903-ba4c3088f100?q=80&w=2670&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D">
<meta property="article:published_time" content="2023-09-01T07:24:23.000Z">
<meta property="article:modified_time" content="2023-09-01T07:24:23.000Z">
<meta property="article:author" content="ANG404">
<meta property="article:tag" content="BLE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1570993492903-ba4c3088f100?q=80&w=2670&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ang404me.github.io/2023/09/01/%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"KO507S2B4N","apiKey":"f97c3f82d7e1bfd4384590360f0bad75","indexName":"hexo","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":3000,"languages":{"author":"作者: ANG404","link":"链接: ","source":"来源: ANG404's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '低功耗蓝牙BLE',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-01 15:24:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DibbupDOTKvQMfAaYkjlvq4nR5Zkxd8ebYiauKfmGDGzYHbP5xhEG0FXkCoT3KaC8xe7WguiaKLA3AzNuYGe2V8ibg/132" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 足迹</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影片</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://images.unsplash.com/photo-1570993492903-ba4c3088f100?q=80&amp;w=2670&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D')"><nav id="nav"><span id="blog-info"><a href="/" title="ANG404's Blog"><span class="site-name">ANG404's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 足迹</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影片</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">低功耗蓝牙BLE</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-01T07:24:23.000Z" title="发表于 2023-09-01 15:24:23">2023-09-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-01T07:24:23.000Z" title="更新于 2023-09-01 15:24:23">2023-09-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%80%9A%E4%BF%A1/">通信</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="低功耗蓝牙BLE"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>一、蓝牙技术发展史</h1>
<p><img src="https://cdn.buct-alcp.top/20240616141303.png" alt=""></p>
<h1>二、低功耗蓝牙和经典蓝牙</h1>
<p><img src="https://cdn.buct-alcp.top/20240616141329.png" alt=""></p>
<h2 id="2-1-单模蓝牙与双模蓝牙">2.1 单模蓝牙与双模蓝牙</h2>
<p>单模蓝牙具有Bluetooth Smart标识，<strong>仅支持低功耗蓝牙</strong>，可以与“Bluetooth Smart Ready”或“Bluetooth Smart”设备通信，单双模的区分是从BLE出来后才有的。</p>
<p>双模蓝牙具有Bluetooth Smart Ready标识，<strong>兼容经典蓝牙与低功耗蓝牙</strong>，可以运行两套协议堆栈，低功耗蓝牙与经典蓝牙使用相同2.4GHz无线电频率，因此双模设备可以共享同一个天线；一般应用于具有稳定电源供电的设备，如手机，PC 等基本是双模的蓝牙芯片。</p>
<img src="https://cdn.buct-alcp.top/20240616141514.png" style="zoom:50%;" />
<h2 id="2-2-两种蓝牙的应用场景">2.2 两种蓝牙的应用场景</h2>
<p>低功耗蓝牙：</p>
<ol>
<li>物联网（IoT）设备连接：BLE非常适合用于连接物联网设备，如智能家居设备、穿戴式设备、健康追踪器等。由于BLE在连接和数据传输时的低功耗特性，使得设备可以长时间工作而不需要频繁充电。</li>
<li>传感器应用：许多传感器设备（例如温度传感器、湿度传感器、运动传感器等）使用BLE来与其他设备或智能手机进行通信。这些传感器通常需要长时间运行，但功耗要求很低。</li>
<li>健康与健身追踪：BLE被广泛用于连接智能手表、健身追踪器、心率监测器等设备。它可以实时传输健康数据，同时保持设备的电池寿命。</li>
<li>室内定位和广告推送：BLE可以用于室内定位和位置服务应用，如商场导航、室内广告推送等，因为它可以在低功耗下发送小型数据包。</li>
<li>智能家居：BLE可用于连接智能家居设备，如智能灯泡、智能插座、智能门锁等，以实现远程控制和自动化。</li>
</ol>
<p>经典蓝牙：</p>
<ol>
<li>音频设备连接：经典蓝牙广泛用于连接音频设备，如耳机、音箱、汽车音响系统等，因为它能够提供高质量的音频传输。</li>
<li>数据传输：经典蓝牙可以用于快速传输大量数据，如文件传输、图像传输、视频传输等。它提供了更高的传输速度和更大的传输范围。</li>
<li>键盘、鼠标等外设连接：经典蓝牙常用于连接键盘、鼠标、打印机等外围设备，因为它可以提供稳定的连接和低延迟的响应。</li>
<li>汽车连接：经典蓝牙被广泛应用于汽车中，用于连接手机、音频设备、通话设备等，以实现车载系统的功能。</li>
<li>游戏手柄和游戏设备：经典蓝牙用于连接游戏手柄、游戏耳机和其他游戏设备，以提供稳定的连接和低延迟的游戏体验。</li>
</ol>
<h1>三、协议标准</h1>
<p>蓝牙技术联盟（SIG）沿用经典蓝牙的规范内容，为蓝牙低功耗定义了一些profile，<strong>一台设备可以使用多个profile</strong>，这些profile定义了一个设备在特定应用情景下如何工作，制造商应通过在实现中遵循特定的profile以确保兼容性。对于协议规范要有个大概了解。</p>
<h2 id="3-1-健康护理规范">3.1 健康护理规范</h2>
<ul>
<li>BLP（Blood Pressure Profile）———用于血压测量。</li>
<li>HTP（Health Thermometer Profile）————用于医疗温度测量设备。</li>
<li>GLP（Glucose Profile）————用于血糖监测。</li>
<li>CGMP（Continuous Glucose Monitor Profile）。</li>
</ul>
<h2 id="3-2-运动健身规范">3.2 运动健身规范</h2>
<ul>
<li>BCS（Body Composition Service）————身体监测服务</li>
<li>CSCP（Cycling Speed and Cadence Profile）———— 用于连接到自行车或健身单车传感器，测量节奏和轮速</li>
<li>CPP（Cycling Power Profile）</li>
<li>HRP（心率规范）</li>
<li>LNP（位置和导航规范）</li>
<li>RSCP（Running Speed and Cadence Profile）</li>
<li>WSP（Weight Scale Profile）</li>
</ul>
<h2 id="3-3-其他规范">3.3 其他规范</h2>
<ul>
<li>IPSP（互联网协议支持规范）</li>
<li>ESP（环境感应规范）</li>
<li>UDS（用户数据服务）</li>
<li>HFP（Hands-Free）蓝牙免提协议</li>
<li>A2DP（Advanced Audio Distribution）蓝牙音乐协议</li>
<li>IAP：苹果的特有协议，用于carplay等</li>
<li>HID（HUMAN INTERFACE DEVICE）：人机接口协议，用于蓝牙鼠标、键盘、手柄等</li>
<li>Battery Service（电池服务）报告“电池状态”和设备中单个电池或电池组的电量级别。</li>
</ul>
<h1>四、BLE协议栈</h1>
<p><img src="https://cdn.buct-alcp.top/20240616141717.png" alt=""><img src="https://cdn.buct-alcp.top/20240616141732.png"  /></p>
<h2 id="4-1-PHY">4.1 PHY</h2>
<p>物理层(Physical Layer)：物理通信介质，负责调制方案、频带、信道的使用、发射器和接收器特性，<strong>PHY层设计的不好直接影响到BLE的功耗和灵敏度等</strong>，射频工程师的主要工作就是调试好PHY层。</p>
<p>频率范围是2.400-2.4835 GHz，将整个频带分为40份（各通道分布如下图，并非顺序分布，每通道的带宽为2MHz，称作RF Channel（射频信道）。</p>
<p><strong>广播通道37：2.402Ghz；广播通道38：2.426Ghz；广播通道39：2.480Ghz；其它的都是数据通道。</strong></p>
<p><img src="https://cdn.buct-alcp.top/20240616141853.png" alt=""></p>
<h2 id="4-2-LL">4.2 LL</h2>
<p>链路层(Link Layer)：链路管理，是整个协议栈的核心，定义了空中接口数据包格式、比特流处理程序（例如错误检查）、状态机以及用于无线通信和链路控制的协议；主要负责信道管理、广播和扫描、创建和保持连接、收发空中包和加密链路。</p>
<h3 id="数据包格式">数据包格式</h3>
<p><img src="https://cdn.buct-alcp.top/20240616141933.png" alt=""></p>
<p>有两种数据包格式（一个为LE未编码的PHY数据格式，一种为LE编码的PHY数据格式），通常为第一种；</p>
<p><strong>格式</strong>：<strong>前导序列 + 访问地址 + PDU报头 + PDU长度 + PDU数据 + CRC</strong></p>
<p>（PDU：Protocol Data Unit；octets：8位byte）</p>
<ul>
<li>
<p>Preamble：是一个01010101（0x55）或者10101010(0xAA)的8bit交替序列。如果接入地址的最高位是0，前导序列则是01010101，否则是10101010，这样的设计是为了保证报文的前9位都是交替的。</p>
</li>
<li>
<p>Access-Address：一个32位的地址，官方文档描述如下图所示，访问地址用来排除噪音和其它链路数据包的干扰。它可以分为：</p>
<p><img src="https://cdn.buct-alcp.top/20240616142102.png" alt=""></p>
<ul>
<li>广播访问地址：是一个固定值（0x8E89BED6），扫描到数据包后验证确认是广播访问地址后才把它认定为广播包，否则认为是噪音或者无效包；</li>
<li>数据访问地址：是一个随机值，不同的连接对应不同的值；当主机扫描到广播后，发送连接请求，这个请求会包含一个连接访问地址（断开重连后此地址不同，随机生成），连接上后数据包都是用这个地址。</li>
</ul>
</li>
<li>
<p>PDU报头：</p>
<ul>
<li>
<p>格式：</p>
 <img src="https://cdn.buct-alcp.top/20240616142214.png" style="zoom:67%;" />
</li>
<li>
<p>类型有：</p>
</li>
<li>
<p>ADV_IND ：可连接的非定向广播，表示当前设备可以接受任何设备的连接请求；</p>
</li>
<li>
<p>ADV_DIRECT_IND：可连接的定向广播，设备不能被主动扫描；</p>
</li>
<li>
<p>ADV_NONCONN_IND：不可连接的非定向广播，仅发送广播数据，而不被连接；</p>
</li>
<li>
<p>ADV_SCAN_IND：可扫描的非定向广播，设备可以被发现，既可以发送广播数据，也可以响应扫描发送扫描回应数据，但不能建立连接；</p>
</li>
<li>
<p>SCAN_REQ：主动扫描请求；</p>
</li>
<li>
<p>SCAN_RSP ：主动扫描回复；</p>
</li>
<li>
<p>CONNECT_REQ ：连接请求；</p>
</li>
</ul>
</li>
<li>
<p>数据包报头：</p>
<ul>
<li>
<p>格式：</p>
 <img src="https://cdn.buct-alcp.top/20240616142325.png" style="zoom:67%;" />
</li>
</ul>
</li>
<li>
<p>PDU长度+PDU数据</p>
</li>
<li>
<p>CRC：3字节校验码</p>
</li>
</ul>
<h3 id="链路层状态机">链路层状态机</h3>
<ul>
<li>Standby：待机状态；</li>
<li>Advertising: 发送广播包；</li>
<li>Scaning：主动或被动扫描；</li>
<li>Initiating：初始化连接设备；</li>
<li>Connection：连接上，可通信状态。</li>
</ul>
<p><img src="https://cdn.buct-alcp.top/20240616142418.png" alt=""></p>
<h2 id="4-3-HCI">4.3 HCI</h2>
<p>主机接口规范(Host controller Interface)：主机和控制器之间的接口，用于在蓝牙设备的主机(Host)和控制器(Controller)之间进行通信。HCI 定义了主机和控制器之间的通信协议和数据格式，使得不同厂商的主机和控制器能够进行互操作。该层可以由软件API实现或者使用硬件接口 UART、SPI、USB、SDIO来控制。</p>
<p>主机是负责处理蓝牙协议栈上层逻辑的部分，例如<strong>应用程序</strong>和<strong>操作系统的蓝牙软件栈</strong>。而控制器是负责管理物理层和链路层操作的部分，包括<strong>射频(RF)部分</strong>和<strong>基带(Baseband)部分</strong>。</p>
<p>HCI 为主机和控制器之间定义了一组命令和事件。主机可以通过发送命令给控制器来控制蓝牙设备的行为，例如扫描周围的蓝牙设备、建立连接、发送数据等。而控制器则可以通过发送事件给主机来通知主机发生的一些重要事件，例如接收到新的数据、连接状态改变等。</p>
<p>HCI 的主要功能包括：</p>
<ol>
<li>命令传输：主机可以向控制器发送命令，控制器执行这些命令并返回执行结果。</li>
<li>事件传输：控制器可以向主机发送事件，通知主机发生了一些重要的事件。</li>
<li>数据传输：主机和控制器之间可以进行数据的双向传输，例如主机可以向控制器发送数据包，控制器也可以向主机发送数据包。</li>
<li>错误报告：控制器可以向主机报告一些错误事件，例如连接失败、数据传输失败等。</li>
</ol>
<h2 id="4-4-L2CAP">4.4 L2CAP</h2>
<p>在蓝牙低功耗（BLE）协议栈中，L2CAP（Logical Link Control and Adaptation Protocol，逻辑链路控制和适配器协议）是位于传输层上方的一个协议。L2CAP 主要负责为上层协议（如GATT和ATT）提供数据通道，以便它们可以在蓝牙连接上进行数据交换。</p>
<p>以下是 L2CAP 的主要功能和特点：</p>
<ol>
<li>提供数据通道：L2CAP 提供了逻辑数据通道，用于在蓝牙设备之间传输上层协议的数据。这些数据通道可以用于传输 GATT（Generic Attribute Profile）协议、ATT（Attribute Protocol）协议以及应用层的自定义协议数据。</li>
<li>数据分段和重组：L2CAP 负责将大块的数据分割成适当大小的数据块进行传输，并在接收端重新组装这些数据块。这种数据分段和重组的功能使得 L2CAP 能够在蓝牙低能耗连接上传输较大的数据负载。</li>
<li>服务质量管理：L2CAP 支持通过不同的通道类型和参数来提供不同的服务质量（<strong>QoS</strong>），以满足不同应用的需求。例如，可以通过配置数据通道的传输速率、传输延迟和连接稳定性来提供不同级别的服务质量。</li>
<li>通道复用和多路复用：L2CAP 支持在单个蓝牙连接上创建多个逻辑数据通道，以便同时支持多个上层协议或应用。这种通道复用和多路复用的机制使得蓝牙设备可以同时处理多种不同类型的数据流量。</li>
<li>协议适配：L2CAP 通过适配器协议（Adaptation Protocol）来与底层的物理层和链路层进行通信，从而<strong>实现了上层协议与底层硬件的解耦</strong>。这种协议适配的机制使得蓝牙设备可以支持不同的物理层和链路层技术，从而提高了设备的灵活性和可扩展性。</li>
</ol>
<h2 id="4-5-SMP">4.5 SMP</h2>
<p>在蓝牙低功耗（BLE）协议栈中，SMP（Security Manager Protocol，安全管理协议）是负责处理设备之间的安全认证和密钥协商的协议。SMP 协议提供了一种安全机制，用于保护蓝牙设备之间的通信安全性和隐私性。</p>
<p>以下是 SMP 协议的主要功能和特点：</p>
<ol>
<li>安全连接建立：SMP 协议负责在蓝牙设备之间建立安全连接，以确保通信的安全性。安全连接可以防止窃听、篡改和重放攻击，从而保护通信的隐私性和完整性。</li>
<li>身份认证：SMP 协议支持在蓝牙设备之间进行身份认证，以确保通信双方的身份合法和可信。<strong>身份认证可以通过密码、数字证书、密钥交换等方式进行</strong>，以确保通信的安全性和可靠性。</li>
<li>密钥协商：SMP 协议负责在安全连接建立过程中协商和生成会话密钥，以用于后续的数据加密和解密。密钥协商过程可以采用各种密码学算法和协议，例如 Diffie-Hellman 密钥交换算法、ECDH（Elliptic Curve Diffie-Hellman）算法等。</li>
<li>安全参数配置：SMP 协议允许设备配置各种安全参数，如连接超时、加密要求、身份认证要求等，以满足不同安全级别和应用场景的需求。</li>
<li>密钥管理：SMP 协议负责管理设备之间生成的密钥，包括长期密钥（Long Term Key，LTK）、会话密钥（Session Key）等。它确保密钥的安全存储和传输，以防止密钥泄露和被恶意利用。</li>
</ol>
<h2 id="4-6-ATT">4.6 ATT</h2>
<p>在蓝牙低功耗（BLE）协议栈中，ATT（Attribute Protocol，属性协议）是一种用于管理蓝牙设备之间数据交换的协议。ATT 协议定义了一种轻量级的数据交换机制，用于在蓝牙设备之间传输和管理属性数据。</p>
<p>它分为两个角色：Server和Client，<strong>通常从机为服务端</strong>，<strong>主机为客户端</strong>；<strong>服务端提供拥有关联值的属性集</strong> ，客户端发现、读、写这些属性，服务端也可以主动通知(notify)客户端。</p>
<ul>
<li>属性类型：用UUID(16bit or 128 bit)的形式来表现；</li>
<li>属性句柄：用于标识一个属性，服务器上的所有属性都会分配一个唯一非零的属性句柄；</li>
<li>属性权限：使用许可、认证许可、授权许可；</li>
<li>属性值    ：0-512 byte。</li>
<li>属性方法类型：
<ul>
<li>– <strong>请求</strong>(客户端到服务端) – <strong>应答</strong>(服务端到客户端，是对请求的回应) – <strong>命令</strong>(客户端到服务端，不需要应答) – <strong>通知</strong>(服务端到客户端，不要确认) – <strong>指示</strong>(服务端到客户端) – <strong>确认</strong>(客户端到服务端，是对指示的回应)。</li>
</ul>
</li>
</ul>
<p>以下是 ATT 协议的主要功能和特点：</p>
<ol>
<li>属性模型：ATT 协议基于属性模型，将设备的功能和数据组织为一组属性（Attributes）。每个属性都有一个唯一的标识符（Attribute Handle），用于在设备之间进行标识和访问。属性可以包含各种类型的数据，如**服务（Service）、特征（Characteristic）、描述符（Descriptor）**等。</li>
<li>客户端-服务器模型：ATT 协议采用客户端-服务器模型，其中一个设备作为客户端（Client），另一个设备作为服务器（Server）。客户端可以向服务器请求属性数据，也可以向服务器写入属性数据。服务器负责响应客户端的请求，并提供所需的属性数据。</li>
<li>GATT 协议的基础：ATT 协议是 GATT（Generic Attribute Profile，通用属性配置文件）协议的基础。GATT 在 ATT 协议之上构建了更高层次的抽象，定义了更具体的属性和属性之间的关系，例如服务、特征、描述符等。</li>
<li>轻量级的数据交换：ATT 协议采用轻量级的数据交换机制，使用较小的数据包进行属性数据的传输。这种设计使得 BLE 设备在低能耗的情况下能够高效地进行数据交换，从而延长了设备的电池寿命。</li>
<li>通信的抽象层：ATT 协议提供了一种通用的数据交换机制，可以用于传输各种类型的属性数据，包括传感器数据、控制命令、配置参数等。它为 BLE 应用提供了通用的通信抽象层，使得不同类型的 BLE 设备可以进行数据交换和通信。</li>
</ol>
<h2 id="4-7-GATT">4.7 GATT</h2>
<p>在蓝牙低功耗（BLE）协议栈中，GATT（Generic Attribute Profile，通用属性配置文件）是建立在 Attribute Protocol（ATT）之上的一个协议，用于管理和描述蓝牙设备之间的数据交换和通信。GATT定义了服务的流程、格式及其所包含的特征，包含特征的**发现、读取(read)、写入(write)、通知(notify)、指示(indicate)。**GATT主要用来规范attribute中的数据内容，并将不同attribute进行分组分类。</p>
<p><img src="https://cdn.buct-alcp.top/20240616142631.png" alt=""></p>
<p><img src="https://cdn.buct-alcp.top/20240616142643.png" alt=""></p>
<p>以下是 GATT 协议的主要功能和特点：</p>
<ol>
<li>按Attribute分组：GATT 将不同Attribute进行分组分类：Service/Characteristic/Descriptor。</li>
<li>Attribute操作：GATT 定义了一组标准的属性操作，包括读取、写入、通知和指示等。通过这些属性操作，客户端可以向服务器请求特征值的数据，也可以向服务器写入特征值的数据。</li>
<li>客户端-服务器模型：GATT 采用客户端-服务器模型，其中一个设备作为客户端（Client），另一个设备作为服务器（Server）。客户端负责发起属性操作请求，服务器负责响应请求并提供所需的特征值数据。</li>
<li>UUID：GATT 使用 UUID（Universally Unique Identifier，通用唯一标识符）来唯一标识服务、特征和描述符。UUID 可以是标准化的 16 位 UUID，也可以是更灵活的 128 位 UUID。</li>
<li>通知和指示：GATT 支持服务器向客户端发送通知和指示，以实时更新特征值的状态和数据。notify是一种无需客户端确认的数据传输方式，而indicate则需要客户端发送确认响应。</li>
<li>描述符：除了服务和特征外，GATT 还支持描述符（Descriptor），用于描述特征值的元数据信息，如单位、格式、权限等。</li>
</ol>
<h3 id="Profile-Service-Characteristic-Descriptor">Profile/Service/Characteristic/Descriptor</h3>
<ol>
<li>
<p>Profile（配置文件）：</p>
<ul>
<li>Profile 是一种规范，定义了蓝牙设备之间的通信协议和数据交换方式。它描述了设备的功能和行为，以及设备之间的数据交互方式。每个 Profile 都包含一个或多个 Service。</li>
</ul>
</li>
<li>
<p>Service（服务）：</p>
<ul>
<li>Service 是一组相关的特征（Characteristic）的集合，用于描述设备的某一方面功能。一个 Service 可以包含一个或多个 Characteristic。每个 Service 都有一个唯一的 UUID 用于标识。</li>
</ul>
</li>
<li>
<p>Characteristic（特征）：</p>
<ul>
<li>
<p>Characteristic 是最小的数据单元，表示设备的一个属性或功能。它包含了一个值（Value）和一些可选的描述符（Descriptor）。Characteristic 的属性（Properties）描述了它的行为和权限，包括读取、写入、通知等。每个 Characteristic 都有一个唯一的 UUID 用于标识。</p>
</li>
<li>
<p>Properties：Characteristic 的属性指定了它的行为和权限，例如读取、写入、通知等。常见的属性包括 READ、WRITE、NOTIFY、INDICATE 等。</p>
</li>
<li>
<p>Value：Characteristic 的值是一个或多个字节的数据，表示特征的当前状态或数据。值的格式和含义由特征的定义确定。</p>
</li>
<li>
<p>Descriptor（描述符）：Descriptor 是对特征值的描述，用于提供关于特征值的元数据信息，如单位、格式、权限等。</p>
</li>
</ul>
</li>
<li>
<p>Descriptor（描述符）：</p>
<ul>
<li>Descriptor 是对特征值的描述，用于提供关于特征值的元数据信息，如单位、格式、权限等。Descriptor 不是必需的，但可以为特征值提供额外的信息和控制。</li>
</ul>
</li>
</ol>
<h3 id="UUID">UUID</h3>
<p><strong>GATT</strong>层中定义的所有属性(Attribute)都有一个UUID值，UUID是全球唯一的128位的号码，它用来识别不同的特性。蓝牙核心规范中定义了两种UUID：128位的基本UUID和16位的UUID(别名)。所有的蓝牙技术联盟定义UUID共用一个<strong>基本UUID</strong>：<strong>0x0000xxxx-0000-1000-8000-00805F9B34FB</strong></p>
<p>为了进一步简化基本UUID，每一个蓝牙技术联盟定义的属性有一个唯一的16位UUID，以代替上面的基本UUID的‘x’部分。例如，心率测量特性使用0X2A37作为它的16位UUID，</p>
<p>完整的128位UUID为：<strong>0x00002A37-0000-1000-8000-00805F9B34FB</strong></p>
<p>虽然蓝牙技术联盟使用相同的基本UUID，但是16位的UUID足够唯一地识别蓝牙技术联盟所定义的各种属性。蓝牙技术联盟所用的基本UUID不能用于任何定制的属性、服务和特性。<strong>对于定制的属性，必须使用另外完整的128位UUID</strong>。</p>
<ul>
<li>SIG UUID</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, String&gt; attributes = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// Sample Services.</span></span><br><span class="line">        attributes.put(<span class="string">&quot;0000180d-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Heart Rate Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;0000180a-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Device Information Service&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sample Characteristics.</span></span><br><span class="line">        attributes.put(<span class="string">&quot;00002a37-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Heart Rate Measurement&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a29-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Manufacturer Name String&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GATT Services</span></span><br><span class="line">        attributes.put(<span class="string">&quot;00001800-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Generic Access&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001801-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Generic Attribute&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GATT Declarations</span></span><br><span class="line">        attributes.put(<span class="string">&quot;00002800-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Primary Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002801-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Secondary Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002802-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Include&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002803-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Characteristic&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GATT Descriptors</span></span><br><span class="line">        attributes.put(<span class="string">&quot;00002900-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Characteristic Extended Properties&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002901-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Characteristic User Description&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002902-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Client Characteristic Configuration&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002903-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Server Characteristic Configuration&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002904-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Characteristic Presentation Format&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002905-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Characteristic Aggregate Format&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002906-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Valid Range&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002907-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;External Report Reference Descriptor&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002908-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Report Reference Descriptor&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GATT Characteristics</span></span><br><span class="line">        attributes.put(<span class="string">&quot;00002a00-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Device Name&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a01-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Appearance&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a02-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Peripheral Privacy Flag&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a03-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Reconnection Address&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a04-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;PPCP&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a05-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Service Changed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GATT Service UUIDs</span></span><br><span class="line">        attributes.put(<span class="string">&quot;00001802-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Immediate Alert&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001803-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Link Loss&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001804-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Tx Power&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001805-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Current Time Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001806-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Reference Time Update Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001807-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Next DST Change Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001808-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Glucose&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001809-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Health Thermometer&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;0000180a-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Device Information&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;0000180b-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Network Availability&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;0000180d-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Heart Rate&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;0000180e-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Phone Alert Status Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;0000180f-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Battery Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001810-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Blood Pressure&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001811-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Alert Notification Service&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001812-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Human Interface Device&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001813-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Scan Parameters&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001814-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Running Speed and Cadence&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001816-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Cycling Speed and Cadence&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001818-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Cycling Power&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00001819-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Location and Navigation&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GATT Characteristic UUIDs</span></span><br><span class="line">        attributes.put(<span class="string">&quot;00002a06-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Alert Level&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a07-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Tx Power Level&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a08-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Date Time&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a09-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Day of Week&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a0a-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Day Date Time&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a0c-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Exact Time 256&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a0d-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;DST Offset&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a0e-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Time Zone&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a0f-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Local Time Information&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a11-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Time with DST&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a12-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Time Accuracy&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a13-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Time Source&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a14-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Reference Time Information&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a16-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Time Update Control Point&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a17-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Time Update State&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a18-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Glucose Measurement&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a19-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Battery Level&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a1c-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Temperature Measurement&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a1d-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Temperature Type&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a1e-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Intermediate Temperature&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a21-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Measurement Interval&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a22-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Boot Keyboard Input Report&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a23-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;System ID&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a24-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Model Number String&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a25-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Serial Number String&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a26-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Firmware Revision String&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a27-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Hardware Revision String&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a28-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Software Revision String&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a29-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Manufacturer Name String&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a2a-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;IEEE 11073-20601 Regulatory Certification Data List&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a2b-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Current Time&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a31-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Scan Refresh&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a32-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Boot Keyboard Output Report&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a33-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Boot Mouse Input Report&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a34-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Glucose Measurement Context&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a35-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Blood Pressure Measurement&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a36-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Intermediate Cuff Pressure&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a37-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Heart Rate Measurement&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a38-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Body Sensor Location&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a39-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Heart Rate Control Point&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a3e-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Network Availability&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a3f-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Alert Status&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a40-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Ringer Control Point&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a41-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Ringer Setting&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a42-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Alert Category ID Bit Mask&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a43-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Alert Category ID&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a44-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Alert Notification Control Point&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a45-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Unread Alert Status&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a46-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;New Alert&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a47-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Supported New Alert Category&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a48-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Supported Unread Alert Category&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a49-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Blood Pressure Feature&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a4a-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;HID Information&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a4b-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Report Map&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a4c-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;HID Control Point&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a4d-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Report&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a4e-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Protocol Mode&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a4f-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Scan Interval Window&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a50-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;PnP ID&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a51-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Glucose Feature&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a52-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Record Access Control Point&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a53-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;RSC Measurement&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a54-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;RSC Feature&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a55-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;SC Control Point&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a5b-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;CSC Measurement&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a5c-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;CSC Feature&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a5d-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Sensor Location&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a63-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Cycling Power Measurement&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a64-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Cycling Power Vector&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a65-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Cycling Power Feature&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a66-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Cycling Power Control Point&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a67-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Location and Speed&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a68-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Navigation&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a69-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;Position Quality&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a6a-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;LN Feature&quot;</span>);</span><br><span class="line">        attributes.put(<span class="string">&quot;00002a6b-0000-1000-8000-00805f9b34fb&quot;</span>, <span class="string">&quot;LN Control Point&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Custom UUID</li>
</ul>
<p>参考SIG UUID先定义128位<strong>基本UUID</strong>然后再定义16位<strong>对应Attribute的UUID</strong>即可。</p>
<h2 id="4-8-GAP">4.8 GAP</h2>
<p>通用访问协议(Generic Access Profile)：GAP 是所有的蓝牙设备均需实现的Profile，主要用于描述device discovery（设备发现）、connection（连接）、security requirement（安全要求）和authentication（认证） 的行为和方法。</p>
<p>以下是 GAP 的主要功能和特点：</p>
<ol>
<li>广告和发现：GAP 定义了设备的广告机制，允许设备在广播信道上发送广告数据，以便其他设备发现和识别。设备可以通过广播或扫描的方式发现周围的其他设备，从而建立连接或交换数据。</li>
<li>连接建立：GAP 规定了设备之间建立连接的流程和参数设置。包括设备的连接模式（主设备或从设备）、连接参数（连接间隔、连接超时等）、连接权限（公开连接或安全连接）等。</li>
<li>安全性：GAP 提供了一些安全性相关的功能，如设备的可发现性和可连接性设置、安全连接建立流程、配对和加密过程等，以确保通信的安全性和隐私性。</li>
<li>角色定义：GAP 定义了设备的角色，包括**广播器（Broadcaster）、扫描器（Scanner）、主设备（Central）和从设备（Peripheral）**等。每种角色都有不同的功能和行为，用于满足不同的应用需求。</li>
<li>连接参数更新：GAP 允许设备在连接建立后更新连接参数，如修改连接间隔、超时时间等，以优化连接质量和能耗。</li>
</ol>
<h4 id="GAP的四种角色">GAP的四种角色</h4>
<ul>
<li>
<p>Master/Central：主机；扫描广播，发起对从机的连接；</p>
</li>
<li>
<p>Peripheral：从机；发送广播包，允许被主机连接；</p>
</li>
<li>
<p>Observer/Scanner：观察者；不能发起连接，只能持续扫描广播包；</p>
</li>
<li>
<p>Broadcaster：广播者；不能被主机连接，只能广播数据。</p>
<p><img src="https://cdn.buct-alcp.top/20240616142955.png" alt=""></p>
</li>
</ul>
<p><img src="https://cdn.buct-alcp.top/20240616142947.png" alt=""></p>
<h1>五、BLE工作流程</h1>
<p><img src="https://cdn.buct-alcp.top/20240616143007.png" alt=""></p>
<h2 id="5-1-广播-Advertising">5.1 广播(Advertising)</h2>
<p>从机在37、38、39信道上依次发送同一个广播包，信道顺序不定，三个信道都发送完成后，就称为一个广播事件；相邻两个广播事件的时间间隔就为广播间隔，必须是“0.625ms”的整数倍，时间范围是从20ms到10.24s，广播间隔越大，连接的时间越长，功耗越低。BLE链路层会在两个广播事件之间添加一个0~10ms的随机延时，保证多个设备广播时，不会一直发生广播碰撞；例如，软件设置广播间隔为62.5ms，则实际的时间间隔为62.5~72.5ms之间。</p>
<p><img src="https://cdn.buct-alcp.top/20240616143048.png" alt=""></p>
<p><img src="https://cdn.buct-alcp.top/20240616143114.png" alt=""></p>
<h2 id="5-2-扫描-Scanning">5.2 扫描(Scanning)</h2>
<p>扫描是主机监听从机广播包和发送扫描请求的过程，主机通过扫描，可以获取到从机的广播包以及扫描回应数据包，主机可以对已扫描到的从机设备发起连接请求，从而连接从机设备并通信。</p>
<ul>
<li>
<p>被动扫描（Passive Scanning）：主机监听广播信道的数据，当接收到广播包时，直接上报到Host端；</p>
</li>
<li>
<p>主动扫描（Active Scanning）：当接收到广播包时，向从机发送一个扫描请求，以获取更多从机信息，从机收到该请求时，会再次发送一个扫描回应包。</p>
</li>
<li>
<p>扫描的基本流程为：设置扫描参数 -&gt; 扫描使能 -&gt; controller向host上报扫描结果 -&gt; 停止扫描。</p>
</li>
<li>
<p>扫描窗口和扫描间隔：如果扫描窗口等于扫描间隔，那么主机将一直处于扫描状态之中，持续监听从机广播包，导致ble无法执行其它操作，同时增加主机能耗，所以，通常设置扫描窗口小于扫描时间。</p>
<p><img src="https://cdn.buct-alcp.top/20240616143239.png" alt=""></p>
</li>
</ul>
<h2 id="5-3-连接-Connection">5.3 连接(Connection)</h2>
<p>到底什么叫连接(connection)？像有线UART，很容易理解，就是用线（Rx和Tx等）把设备A和设备B相连，即为连接。用“线”把两个设备相连，实际是让2个设备有共同的通信媒介，并让两者时钟同步起来。蓝牙连接有何尝不是这个道理，<strong>所谓设备A和设备B建立蓝牙连接，就是指设备A和设备B两者一对一“同步”成功</strong>，其具体包含以下几方面：</p>
<ul>
<li>
<p>设备A和设备B对接下来要使用的物理信道达成一致</p>
</li>
<li>
<p>设备A和设备B双方建立一个共同的时间锚点，也就是说，把双方的时间原点变成同一个点</p>
</li>
<li>
<p>设备A和设备B两者时钟同步成功，即双方都知道对方什么时候发送数据包什么时候接收数据包</p>
</li>
<li>
<p>连接成功后，设备A和设备B通信流程如下所示：</p>
<p><img src="https://cdn.buct-alcp.top/20240616143316.png" alt=""></p>
</li>
</ul>
<p><strong>BLE连接涉及到三个重要的连接参数</strong>，通过修改这三个连接参数直接影响ble连接中的功耗和连接速度:</p>
<ol>
<li>
<p>Connection Interval（连接间隔，CI）：BLE设备间的连接是采用了跳频方案的，在特定的频道中相互收发数据，<strong>两个信道切换的间隔就称为连接间隔</strong>，连接间隔以1.25ms为一个单元，范围是6 ~ 3200既7.5ms ~ 4s之间，就算两设备间没有数据被发送和接收，仍然会交换链路层数据（空包）来维持连接。<strong>增大Connection Interval值，会降低数据包吞吐量，降低功耗。</strong></p>
</li>
<li>
<p>Slave Latency（从设备延迟）：从机可以在没有数据要发的情况下，跳过一定数目的连接事件，不需要回复主机的数据包，<strong>节省从机功耗</strong>。该参数设置范围为0 ~ 499。如下图所示，OFF表示值为0，ON表示值大于0。Slave Latency = 0 时，对于每次连接事件从机必须要回复，不回复则认为是从机通讯故障；Slave Latency = 3 时，如果从机没有要回复的数据包，则可以忽略3个事件，第四个事件到来再回复；如果从机有要回复的数据包，不管Slave Latency配置为多少都应立即回复。</p>
<p><img src="https://cdn.buct-alcp.top/20240616143344.png" alt=""></p>
</li>
<li>
<p>Supervision Timeout（监控超时）：如果BLE在Timeout时间内没有发生通信，就会自动断开。配置范围是10 ~ 3200（一个单位为 10ms），即时间范围是100ms ~ 32s。。</p>
</li>
</ol>
<h4 id="更新连接参数">更新连接参数</h4>
<p>连接参数由主机发起连接的时候提供给从机，如果从机对连接参数有自己的要求，可以在连接后发起连接参数更新请求，更改连接参数值。</p>
<h2 id="5-4-通信-Communication">5.4 通信(Communication)</h2>
<p><img src="https://cdn.buct-alcp.top/20240616143316.png" alt=""></p>
<p>通信流程如上图所示，一旦设备A和设备B连接成功（此种情况下，我们把设备A称为<strong>Master</strong>或者<strong>Central</strong>，把设备B称为<strong>Slave</strong>或者<strong>Peripheral</strong>），设备A将周期性以CI（connection interval）为间隔向设备B发送数据包，而设备B也周期性地以CI为间隔打开射频接收窗口以接收设备A的数据包。同时按照蓝牙spec要求，设备B收到设备A数据包<strong>150us后</strong>，设备B切换到发送状态，把自己的数据发给设备A；设备A则切换到接收状态，接收设备B发过来的数据。由此可见，连接状态下，<strong>设备A和设备B的射频发送和接收窗口都是周期性地有计划地开和关，而且开的时间非常短，从而大大降低系统功耗并大大提高系统效率。</strong></p>
<p>现在我们看看连接状态下是如何把数据0x53发送出去的，从中大家可以体会到蓝牙协议栈分层的妙处:</p>
<ul>
<li>对开发者来说，很简单，他只需要调用send(0x53)</li>
<li>GATT层定义数据的类型和分组，方便起见，我们用0x0013表示电量这种数据类型，这样GATT层把数据打包成130053（<strong>小端模式</strong>！）</li>
<li>ATT层用来选择具体的通信命令，比如read/write/notify/indicate等，这里选择notify命令0x1B，这样数据包变成了：1B130053</li>
<li>L2CAP用来指定connection interval（连接间隔），比如每10ms同步一次（CI不体现在数据包中），同时指定逻辑通道编号0004（表示ATT命令），最后把ATT数据长度0x0004加在包头，这样数据就变为：040004001B130053</li>
<li>LL层要做的工作很多，首先LL层需要指定用哪个物理信道进行传输（物理信道不体现在数据包中），然后再给此连接分配一个Access address（0x50655DAB）以标识此连接只为设备A和设备B直连服务，然后加上LL header和payload length字段，LL header标识此packet为数据packet，而不是control packet等，payload length为整个L2CAP字段的长度，最后加上CRC24字段，以保证整个packet的数据完整性，所以数据包最后变成：
<ul>
<li>AAAB5D65501E08040004001B130053D550F6
<ul>
<li>AA – 前导帧(preamble)</li>
<li>0x50655DAB – 访问地址(access address)</li>
<li>1E – LL帧头字段(LL header)</li>
<li>08 – 有效数据包长度(payload length)</li>
<li>04000400 – ATT数据长度，以及L2CAP通道编号</li>
<li>1B – notify command</li>
<li>0x0013 – 电量数据handle</li>
<li>0x53 – 真正要发送的电量数据</li>
<li>0xF650D5 – CRC24值</li>
<li>虽然开发者只调用了 send(0x53)，但由于低功耗蓝牙协议栈层层打包，最后空中实际传输的数据将变成下图所示的模样，这就既满足了低功耗蓝牙通信的需求，又让用户API变得简单，可谓一箭双雕！</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iini/p/8969828.html">深入浅出低功耗蓝牙(BLE)协议栈</a></p>
<p><a target="_blank" rel="noopener" href="http://t.csdnimg.cn/9uz0v">低功耗蓝牙（BLE）你入门了吗</a></p>
</blockquote>
<h2 id="5-5-微信小程序调用示例">5.5 微信小程序调用示例</h2>
<p><img src="https://cdn.buct-alcp.top/20240607152319.png" alt=""></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://ANG404me.github.io">ANG404</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ang404me.github.io/2023/09/01/%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99/">https://ang404me.github.io/2023/09/01/%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ANG404me.github.io" target="_blank">ANG404's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/BLE/">BLE</a></div><div class="post_share"><div class="social-share" data-image="https://images.unsplash.com/photo-1570993492903-ba4c3088f100?q=80&amp;w=2670&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/05/%E3%80%90SoC%20FPGA%E3%80%91OpenCL%E5%BC%82%E6%9E%84%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80/" title="【SoC FPGA】3.OpenCL异构计算基础"><img class="cover" src="https://images.unsplash.com/photo-1720451815682-3353b81a6633?q=80&amp;w=3604&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【SoC FPGA】3.OpenCL异构计算基础</div></div></a></div><div class="next-post pull-right"><a href="/2023/08/30/%E3%80%90SoC%20FPGA%E3%80%91GDB%20Server%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95%E3%80%81GDB%20ARM%20%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="【SoC FPGA】2.GDB Server远程调试、GDB ARM 交叉编译环境搭建"><img class="cover" src="https://plus.unsplash.com/premium_photo-1663946899728-39b7b401535e?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=1335&amp;q=80" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【SoC FPGA】2.GDB Server远程调试、GDB ARM 交叉编译环境搭建</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DibbupDOTKvQMfAaYkjlvq4nR5Zkxd8ebYiauKfmGDGzYHbP5xhEG0FXkCoT3KaC8xe7WguiaKLA3AzNuYGe2V8ibg/132" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ANG404</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ANG404me"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ANG404me" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">QQ:1453897678</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">一、蓝牙技术发展史</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">二、低功耗蓝牙和经典蓝牙</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%8D%95%E6%A8%A1%E8%93%9D%E7%89%99%E4%B8%8E%E5%8F%8C%E6%A8%A1%E8%93%9D%E7%89%99"><span class="toc-text">2.1 单模蓝牙与双模蓝牙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%B8%A4%E7%A7%8D%E8%93%9D%E7%89%99%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">2.2 两种蓝牙的应用场景</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">三、协议标准</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%81%A5%E5%BA%B7%E6%8A%A4%E7%90%86%E8%A7%84%E8%8C%83"><span class="toc-text">3.1 健康护理规范</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E8%BF%90%E5%8A%A8%E5%81%A5%E8%BA%AB%E8%A7%84%E8%8C%83"><span class="toc-text">3.2 运动健身规范</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%85%B6%E4%BB%96%E8%A7%84%E8%8C%83"><span class="toc-text">3.3 其他规范</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">四、BLE协议栈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-PHY"><span class="toc-text">4.1 PHY</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-LL"><span class="toc-text">4.2 LL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F"><span class="toc-text">数据包格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E5%B1%82%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="toc-text">链路层状态机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-HCI"><span class="toc-text">4.3 HCI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-L2CAP"><span class="toc-text">4.4 L2CAP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-SMP"><span class="toc-text">4.5 SMP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-ATT"><span class="toc-text">4.6 ATT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-GATT"><span class="toc-text">4.7 GATT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Profile-Service-Characteristic-Descriptor"><span class="toc-text">Profile&#x2F;Service&#x2F;Characteristic&#x2F;Descriptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UUID"><span class="toc-text">UUID</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-GAP"><span class="toc-text">4.8 GAP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GAP%E7%9A%84%E5%9B%9B%E7%A7%8D%E8%A7%92%E8%89%B2"><span class="toc-text">GAP的四种角色</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">五、BLE工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%B9%BF%E6%92%AD-Advertising"><span class="toc-text">5.1 广播(Advertising)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%89%AB%E6%8F%8F-Scanning"><span class="toc-text">5.2 扫描(Scanning)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E8%BF%9E%E6%8E%A5-Connection"><span class="toc-text">5.3 连接(Connection)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%BF%9E%E6%8E%A5%E5%8F%82%E6%95%B0"><span class="toc-text">更新连接参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E9%80%9A%E4%BF%A1-Communication"><span class="toc-text">5.4 通信(Communication)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%B0%83%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-text">5.5 微信小程序调用示例</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/11/03/%E3%80%90SoC-FPGA%E3%80%91ALINX-AXU4EVB%E5%BC%80%E5%8F%91%E6%9D%BF%E7%A7%BB%E6%A4%8DPYNQ/" title="【SoC FPGA】7.ALINX AXU4EVB开发板移植PYNQ"><img src="https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&amp;w=2670&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【SoC FPGA】7.ALINX AXU4EVB开发板移植PYNQ"/></a><div class="content"><a class="title" href="/2023/11/03/%E3%80%90SoC-FPGA%E3%80%91ALINX-AXU4EVB%E5%BC%80%E5%8F%91%E6%9D%BF%E7%A7%BB%E6%A4%8DPYNQ/" title="【SoC FPGA】7.ALINX AXU4EVB开发板移植PYNQ">【SoC FPGA】7.ALINX AXU4EVB开发板移植PYNQ</a><time datetime="2023-11-03T06:41:08.000Z" title="发表于 2023-11-03 14:41:08">2023-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/15/%E3%80%90SoC-FPGA%E3%80%91PipeCNN%E4%BB%A3%E7%A0%81%E7%B2%BE%E8%AF%BB/" title="【SoC FPGA】6.PipeCNN代码精读"><img src="https://plus.unsplash.com/premium_photo-1721926057308-2aa7ce470776?q=80&amp;w=3870&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【SoC FPGA】6.PipeCNN代码精读"/></a><div class="content"><a class="title" href="/2023/09/15/%E3%80%90SoC-FPGA%E3%80%91PipeCNN%E4%BB%A3%E7%A0%81%E7%B2%BE%E8%AF%BB/" title="【SoC FPGA】6.PipeCNN代码精读">【SoC FPGA】6.PipeCNN代码精读</a><time datetime="2023-09-15T06:41:08.000Z" title="发表于 2023-09-15 14:41:08">2023-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/12/%E3%80%90SoC%20FPGA%E3%80%91OpenCL%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B/" title="【SoC FPGA】5.OpenCL程序设计流程"><img src="https://images.unsplash.com/photo-1721340143289-94be4f77cda4?q=80&amp;w=2832&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【SoC FPGA】5.OpenCL程序设计流程"/></a><div class="content"><a class="title" href="/2023/09/12/%E3%80%90SoC%20FPGA%E3%80%91OpenCL%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B/" title="【SoC FPGA】5.OpenCL程序设计流程">【SoC FPGA】5.OpenCL程序设计流程</a><time datetime="2023-09-12T06:41:08.000Z" title="发表于 2023-09-12 14:41:08">2023-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/09/%E3%80%90SoC%20FPGA%E3%80%91%E9%9D%A2%E5%90%91Intel%20FPGA%20%E7%9A%84%20OpenCL%2018.1%E8%BF%90%E8%A1%8C%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA/" title="【SoC FPGA】4.面向Intel FPGA 的 OpenCL 18.1运行平台搭建"><img src="https://plus.unsplash.com/premium_photo-1721405381040-10cbc42ee4a5?q=80&amp;w=3870&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【SoC FPGA】4.面向Intel FPGA 的 OpenCL 18.1运行平台搭建"/></a><div class="content"><a class="title" href="/2023/09/09/%E3%80%90SoC%20FPGA%E3%80%91%E9%9D%A2%E5%90%91Intel%20FPGA%20%E7%9A%84%20OpenCL%2018.1%E8%BF%90%E8%A1%8C%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA/" title="【SoC FPGA】4.面向Intel FPGA 的 OpenCL 18.1运行平台搭建">【SoC FPGA】4.面向Intel FPGA 的 OpenCL 18.1运行平台搭建</a><time datetime="2023-09-09T06:41:08.000Z" title="发表于 2023-09-09 14:41:08">2023-09-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/05/%E3%80%90SoC%20FPGA%E3%80%91OpenCL%E5%BC%82%E6%9E%84%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80/" title="【SoC FPGA】3.OpenCL异构计算基础"><img src="https://images.unsplash.com/photo-1720451815682-3353b81a6633?q=80&amp;w=3604&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【SoC FPGA】3.OpenCL异构计算基础"/></a><div class="content"><a class="title" href="/2023/09/05/%E3%80%90SoC%20FPGA%E3%80%91OpenCL%E5%BC%82%E6%9E%84%E8%AE%A1%E7%AE%97%E5%9F%BA%E7%A1%80/" title="【SoC FPGA】3.OpenCL异构计算基础">【SoC FPGA】3.OpenCL异构计算基础</a><time datetime="2023-09-05T06:41:08.000Z" title="发表于 2023-09-05 14:41:08">2023-09-05</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://images.unsplash.com/photo-1570993492903-ba4c3088f100?q=80&amp;w=2670&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By ANG404</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></body></html>